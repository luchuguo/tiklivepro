# 生产环境API配置指南

## 问题分析

你的生产环境存在架构不一致的问题：
- **任务列表**：使用API接口 `https://www.tkgo.vip/api/tasks` ✅ 工作正常
- **任务详情**：直接查询Supabase ❌ 加载失败

## 解决方案

### 1. 创建了任务详情API接口

#### 任务详情API：`/api/task/[id]`
- **路径**：`/api/task/{taskId}`
- **功能**：获取单个任务的详细信息
- **缓存策略**：5分钟边缘缓存 + 10分钟过期数据使用
- **返回数据**：任务信息 + 公司信息 + 分类信息

#### 任务申请API：`/api/task/[id]/applications`
- **路径**：`/api/task/{taskId}/applications`
- **功能**：获取任务的申请列表
- **缓存策略**：1分钟边缘缓存 + 2分钟过期数据使用
- **返回数据**：申请列表 + 达人信息

### 2. 修复了TaskDetailPage

- 从直接查询Supabase改为使用API接口
- 支持API缓存状态显示
- 统一了数据获取方式

## 部署步骤

### 步骤1：确保API文件已创建
确认以下文件已创建：
```
api/
├── tasks.js                    # 任务列表API ✅ 已存在
├── task/
│   ├── [id].js               # 任务详情API ✅ 新创建
│   └── [id]/
│       └── applications.js   # 任务申请API ✅ 新创建
├── categories.js              # 分类API ✅ 已存在
└── influencers.js             # 达人API ✅ 已存在
```

### 步骤2：部署到生产环境
```bash
git add .
git commit -m "添加任务详情和申请列表API接口"
git push origin main
```

### 步骤3：验证API接口
部署完成后，测试以下接口：

#### 测试任务详情API
```bash
curl "https://www.tkgo.vip/api/task/27eea3f2-2118-4776-a5f9-bc42a68f8617"
```

#### 测试任务申请API
```bash
curl "https://www.tkgo.vip/api/task/27eea3f2-2118-4776-a5f9-bc42a68f8617/applications"
```

## 缓存策略说明

### 任务详情缓存
- **边缘缓存**：5分钟（`s-maxage=300`）
- **过期数据使用**：10分钟（`stale-while-revalidate=600`）
- **理由**：任务详情相对稳定，可以缓存较长时间

### 任务申请缓存
- **边缘缓存**：1分钟（`s-maxage=60`）
- **过期数据使用**：2分钟（`stale-while-revalidate=120`）
- **理由**：申请列表变化频繁，需要较短的缓存时间

### 任务列表缓存
- **边缘缓存**：1分钟（`s-maxage=60`）
- **过期数据使用**：允许使用过期数据
- **理由**：列表页面需要快速响应

## 预期效果

部署完成后：

1. **任务详情页面**：应该能够正常加载，不再显示"加载失败"
2. **缓存状态显示**：页面会显示数据是来自缓存还是数据库
3. **性能提升**：API接口提供多层缓存，响应速度更快
4. **架构一致**：所有页面都使用统一的API接口

## 故障排除

### 如果API仍然无法访问

1. **检查Vercel部署状态**：
   - 确认API文件已正确部署
   - 检查Vercel函数日志

2. **验证环境变量**：
   - 确认 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 已设置
   - 检查Vercel KV是否可用

3. **测试API端点**：
   - 使用生产环境数据测试工具
   - 检查浏览器网络请求

### 如果任务详情仍然加载失败

1. **检查浏览器控制台**：
   - 查看是否有API请求错误
   - 确认请求URL是否正确

2. **验证任务ID**：
   - 确认任务ID `27eea3f2-2118-4776-a5f9-bc42a68f8617` 在数据库中存在
   - 使用生产环境数据测试工具验证

## 监控和维护

### 1. 缓存命中率监控
- 观察API响应头中的缓存状态
- 监控Vercel KV的使用情况

### 2. 性能监控
- 监控API响应时间
- 观察用户页面加载体验

### 3. 错误监控
- 设置API错误告警
- 监控Supabase连接状态

## 总结

通过创建任务详情API接口，我们解决了生产环境架构不一致的问题：

- ✅ **统一了数据获取方式**：所有页面都使用API接口
- ✅ **优化了缓存策略**：不同数据类型使用不同的缓存时间
- ✅ **提升了性能**：多层缓存减少数据库查询
- ✅ **改善了用户体验**：页面加载更快，错误更少

部署完成后，你的生产环境应该能够正常显示任务详情页面。 