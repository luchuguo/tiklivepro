# 生产环境缓存问题解决指南

## 问题描述
生产环境中列表页面（tasks, influencers）可以读取服务器缓存，但详细信息页面无法加载缓存。开发环境中列表和详细页面均可以正常加载缓存。

## 问题分析

### 1. 缓存策略不一致
- **列表页面**：使用短期缓存，数据相对稳定
- **详细页面**：需要动态数据，缓存策略可能过于激进

### 2. Vercel路由配置问题
- 动态路由（如 `/influencer/:id`）可能没有正确的缓存配置
- 静态路由和动态路由的缓存策略不同

### 3. 环境变量作用域问题
- 某些环境变量可能只在特定页面生效
- 生产环境和开发环境的配置差异

## 解决方案

### 方案1：优化Vercel配置

已经更新了 `vercel.json` 文件：
- 修正了动态路由配置
- 添加了针对详情页面的缓存策略
- 优化了CORS配置

### 方案2：使用缓存管理工具

创建了 `src/utils/cacheManager.ts`：
- 智能缓存管理
- 支持不同页面的缓存策略
- 持久化缓存存储

### 方案3：生产环境调试工具

添加了 `ProductionDebugger` 组件：
- 实时监控网络状态
- 检测数据库连接
- 运行诊断测试

## 具体操作步骤

### 步骤1：重新部署项目
```bash
# 推送代码到GitHub
git add .
git commit -m "修复生产环境缓存问题"
git push origin main
```

### 步骤2：在Vercel中设置环境变量
确保以下环境变量已正确设置：
```
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your_actual_anon_key
```

### 步骤3：验证缓存配置
部署完成后，检查：
1. 列表页面是否正常加载
2. 详细页面是否可以使用缓存
3. 浏览器控制台是否有错误信息

### 步骤4：使用调试工具
在生产环境中：
1. 展开"生产环境调试器"
2. 点击"运行诊断测试"
3. 查看控制台输出

## 缓存策略优化

### 列表页面缓存
- TTL: 2分钟
- 支持过期数据使用（5分钟内）
- 快速刷新机制

### 详细页面缓存
- TTL: 10分钟
- 支持过期数据使用（30分钟内）
- 智能失效策略

### 静态数据缓存
- TTL: 1小时
- 支持过期数据使用（24小时内）
- 长期存储

## 常见问题排查

### Q: 为什么列表页面可以缓存？
A: 列表页面数据相对稳定，缓存策略更宽松，且Vercel对静态路由的缓存支持更好。

### Q: 为什么详细页面无法缓存？
A: 详细页面需要动态数据，可能存在以下问题：
1. 环境变量配置错误
2. 数据库连接失败
3. 缓存策略过于严格
4. 路由配置问题

### Q: 如何验证缓存是否生效？
A: 
1. 使用浏览器开发者工具查看Network标签
2. 检查是否有重复的API请求
3. 查看缓存管理器的统计信息
4. 使用生产环境调试器

## 预防措施

### 1. 环境变量管理
- 使用环境变量管理所有配置
- 避免硬编码敏感信息
- 定期检查生产环境配置

### 2. 缓存策略优化
- 根据数据特性设置合适的TTL
- 实现智能缓存失效机制
- 监控缓存命中率

### 3. 错误监控
- 实现全局错误捕获
- 记录生产环境错误日志
- 设置告警机制

### 4. 性能优化
- 使用CDN加速静态资源
- 实现懒加载和代码分割
- 优化数据库查询

## 联系支持

如果问题仍然存在，请：
1. 检查浏览器控制台错误信息
2. 查看Vercel部署日志
3. 使用生产环境调试器收集信息
4. 提供详细的错误描述和复现步骤 